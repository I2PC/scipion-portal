{% extends "layouts/contained.html" %}
{% load static %}

{% block title %}Scipion downloads statistics{% endblock %}


{% block js %}
    {{ block.super }}

	<script type="text/javascript" src="{% static "js/download/utils.js" %}"></script>
	<script type="text/javascript" src="{% static "js/download/config.js" %}"></script>
	<script src="http://code.highcharts.com/highcharts.js"></script>
	<script src='{% static "js/highcharts.theme.colorblind.js" %}'></script>
	<script src="https://code.highcharts.com/modules/exporting.js"></script>
	<script src='{% static "js/highcharts.utils.js" %}'></script>
{% endblock %}

{% block content %}
<div>
	<h2 class="mt-4">Scipion downloads statistics</h2>
	<div id="piebyversion"></div><br/>
	<div id="piebyplatform"></div><br/>
	<div id="piebycountry"></div><br/>
	<div id="downloadsovertime"></div><br/>
	<div id="accumulatedDownloads"></div><br/>

	<script>
	var downloadData = {{downloadsJSON|safe}};
	var downloadsAggregation = {};
	var downloadsTimeSeries;

	$(function () {

		$(document).ready(function () {
			loadCharts();
		});
	});

	function loadCharts() {

		prepareData();

		loadVersionChart()
		loadPlatformChart();
		loadCountryChart();
		loadDownloadsTimeSeries();
		loadDownloadsAccumulated();
	}

	function loadVersionChart(){
		var data = propertyAggregationToPieChartData(
		    downloadsAggregation['version'],
			'downloads');

		loadPieChart('#piebyversion', 'Download by version', data);

	};

	function loadPlatformChart(){
		var data = propertyAggregationToPieChartData(downloadsAggregation['platform'], 'downloads');

		loadPieChart('#piebyplatform', 'Download by platform', data);
	};

	function loadCountryChart(){
		var data = propertyAggregationToPieChartData(downloadsAggregation['country'], 'downloads', 2);
		loadPieChart('#piebycountry', 'Downloads by country', data);
	};

	function loadDownloadsTimeSeries(){
		downloadsTimeSeries = propertyAggregationToTimeSeries(downloadsAggregation['timeStamp'], 'Downloads');
		loadZoomableTimeSeries('#downloadsovertime', 'Downloads per day', downloadsTimeSeries)
	};

	function loadDownloadsAccumulated(){

		accumulateData(downloadsTimeSeries[0].data);

		downloadsTimeSeries[0].type='area'

		loadAreaChart('#accumulatedDownloads', 'Accumulated downloads', downloadsTimeSeries)
	};

	function prepareData(){

		// Aggregate data
		aggregateAll(downloadData, downloadsAggregation);

	}


	</script>
</div>
{% endblock %}
